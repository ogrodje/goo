apiVersion: batch/v1
# kind: Job
kind: CronJob
metadata:
  name: discord-events-notifier
  namespace: goo-prod
  labels: { app: discord-events-notifier }
spec:
  schedule: "0 18 * * 0" # Sundays 18:00 UTC (â‰ˆ 19:00 CET in winter)
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  # startingDeadlineSeconds: 600

  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata: { labels: { app: discord-events-notifier } }
        spec:
          restartPolicy: OnFailure
          containers:
            - name: discord-events-notifier
              image: ghcr.io/ogrodje/goo:0.1.26
              args: [ "discord-events-notifier", "Weekly", "$(DISCORD_EVENTS_WEBHOOK)" ]
              env:
                - name: DISCORD_EVENTS_WEBHOOK
                  valueFrom:
                    secretKeyRef: { name: goo-secret, key: discord_events_webhook }
                - { name: GOO_ENVIRONMENT, value: "Production" }
                - { name: PORT, value: "7777" }
                - { name: OTEL_TRACES_EXPORTER, value: "none" }
                - { name: OTEL_METRICS_EXPORTER, value: "none" }
                - { name: OTEL_LOGS_EXPORTER, value: "none" }
                - { name: POSTGRES_DB, value: "goo" }
                - { name: POSTGRES_HOST, value: "pg-one-postgresql.goo-prod.svc.cluster.local" }
                - { name: POSTGRES_PORT, value: "5432" }
                - { name: POSTGRES_USER, value: "goo" }
                - { name: SOURCES, value: "All" }
                - { name: KEYCLOAK_ENDPOINT, value: "https://keycloak.ogrodje.si" }
                - { name: KEYCLOAK_REALM, value: "Ogrodje" }
                - name: SENTRY_AUTH_TOKEN
                  valueFrom:
                    secretKeyRef: { name: goo-secret, key: sentry_auth_token }
                - name: HYGRAPH_ENDPOINT
                  valueFrom:
                    secretKeyRef: { name: goo-secret, key: hygraph_endpoint }
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef: { name: pg-one-postgresql, key: password }

